// This is your Prisma schema file
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Role enum for RBAC
enum Role {
  ADMIN
  DEPARTMENT_USER
}

model User {
  id           String       @id @default(uuid())
  email        String       @unique
  passwordHash String       @map("password_hash")
  name         String
  role         Role         @default(DEPARTMENT_USER)
  departmentId String?      @map("department_id")
  department   Department?  @relation(fields: [departmentId], references: [id])
  
  // Relations
  createdEvents    Event[]      @relation("EventCreator")
  assignedTasks    Assignment[] @relation("AssignedUser")
  assignmentsMade  Assignment[] @relation("AssignedBy")
  
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  
  @@map("users")
}

model Department {
  id        String   @id @default(uuid())
  name      String   @unique
  users     User[]
  assignments Assignment[]
  
  createdAt DateTime @default(now()) @map("created_at")
  
  @@map("departments")
}

model Event {
  id          String   @id @default(uuid())
  name        String
  description String?
  eventDate   DateTime @map("event_date")
  createdById String   @map("created_by")
  createdBy   User     @relation("EventCreator", fields: [createdById], references: [id])
  
  tasks       Task[]
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@map("events")
}

model Task {
  id             String   @id @default(uuid())
  eventId        String   @map("event_id")
  event          Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  sNo            Int      @map("s_no")
  taskName       String   @map("task_name")
  description    String
  departmentName String   @map("department_name")
  
  assignments    Assignment[]
  
  createdAt      DateTime @default(now()) @map("created_at")
  
  @@map("tasks")
  @@index([eventId])
}

model Assignment {
  id           String     @id @default(uuid())
  taskId       String     @map("task_id")
  task         Task       @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  userId       String?    @map("user_id")
  user         User?      @relation("AssignedUser", fields: [userId], references: [id])
  
  departmentId String?    @map("department_id")
  department   Department? @relation(fields: [departmentId], references: [id])
  
  assignedById String     @map("assigned_by")
  assignedBy   User       @relation("AssignedBy", fields: [assignedById], references: [id])
  
  assignedAt   DateTime   @default(now()) @map("assigned_at")
  
  @@map("assignments")
  @@index([taskId])
  @@index([userId])
  @@index([departmentId])
}
